<!DOCTYPE html>
<html lang="zh-cn">
<head>
<title>WebMarket API</title>
<style>

</style>

<link href="http://cdn.bootcss.com/bootstrap/2.3.2/css/bootstrap.css" rel="stylesheet">
<script src="http://cdn.bootcss.com/jquery/2.1.3/jquery.js"></script>
<script src="http://cdn.bootcss.com/bootstrap/2.3.2/js/bootstrap.js"></script>
<script src="console.js"></script>

</head>
<body>
<div class="row-fluid">
	<div class="span6">
	<h4>Console Log</h4>
	<div class="console"> </div>
	</div>
	<div class="span6">
		<div>
				<div class="control-group">
					<div class="controls">
						<input id='sockjs_address' type="text"class="input" value='ws://127.0.0.1:8080/'></input> <button class="btn btn-success" onclick='onCreateSocket()'>CreateSocket</button>
					</div>
				</div>
				<div class="control-group">
				</div>
				
				<div class="control-group">
					<div class="controls">
						<input id='username' type="text" placeholder="username" class="input-small" value='8500001'> <input id='password' type="text" placeholder="password" class="input-small" value='123456'> <button class="btn btn-success" onclick='onLogin()'>Login</button>
					</div>
				</div>
				<div class="control-group">
					<div class="controls">
						<button class="btn btn-success" onclick='onQrySymbols()'>QrySymbols</button>
					</div>
				</div>
				<div class="control-group">
					<div class="controls">
						<input id='register_symbol' type="text"class="input" value='HSIJ7'></input> <button class="btn btn-success" onclick='onRegisterSymbols()'>RegisterSymbols</button>
					</div>
				</div>
				
				<div class="control-group">
					<div class="controls">
						<input id='bar_interval' type="text" class="input-small" value='60'><input id='bar_exchange' type="text" class="input-small" value='HKEX'> <input id='bar_symbol' type="text" class="input-small" value='HSIJ7'> <input id='bar_startindex' type="text" class="input-small" value='0'> <input id='bar_maxcount' type="text" class="input-small" value='100'> <button class="btn btn-success" onclick='onQryBar()'>QryBar</button>
					</div>
				</div>
				
					
    </div>

	</div>
</div>
<script>
//连接对象
var conn;
var requestID=0;
function debug(msg)
{
	kendoConsole.log(msg);
}
/*
通过socket发送数据
*/
function send(obj)
{
	var jsondata=JSON.stringify(obj);
	if(conn != null)
	{
		conn.send(jsondata);
		debug("send request:" + jsondata);
	}
	else
	{
		debug('please create socket first');
	}
}
function onSockMessage(e)
{
	var d = $.parseJSON(e.data);//JSON.parse(e.data);
	msgtype = d['msgtype'];
	data = d['payload'];
	debug("got response:"+e.data)
}

/*
订阅合约行情数据
*/
function onRegisterSymbols()
{
	var dic = {'MessageType':4000,"Request":{"SymbolID":$("#register_symbol").val(),"FieldID":240},"RequestID":++requestID};
	send(dic);
}


/*
注销合约行情数据
*/
function onClearSymbols()
{
	var dic = {'msgtype':'ClearSymbols','payload':''};
	send(dic);
}



/*
登入
*/
function onLogin()
{
	var dic = {"MessageType":1000,"Request":{"UserID":$("#username").val(),"Password":$("#password").val(),"UserProductInfo":"WebSocket HTML","MacAddress":"XXXX","ClientIPAddress":null,"FieldID":100},"RequestID":++requestID};
	send(dic);
}

/*
查询Bar数据
ExchangeID：交易所代码
SymbolID：合约代码
Interval：周期数，1分钟 60 ，2分钟 120秒，折算成秒
StartIndex：开始序号，0表示最近的一个Bar
MaxCount：最多返回数据个数
Start：开始时间 20170407113154 表示时间 2017-04-07 11:31:54
End：结束时间
*/
function onQryBar()
{
	var dic = {"MessageType":4005,"Request":{"ExchangeID":$("#bar_exchange").val(),"SymbolID":$("#bar_symbol").val(),"Interval":$("#bar_interval").val(),"StartIndex":$("#bar_startindex").val(),"MaxCount":$("#bar_maxcount").val(),"Start":190001010000,"End":201801010000,"HavePartial":true,"FieldID":244},"RequestID":++requestID};
	send(dic);
}


/*
查询合约
*/
function onQrySymbols()
{
	var dic = {"MessageType":2000,"Request":{"SymbolID":null,"ExchangeID":$("#qrysym_exchange").val(),"SecurityID":$("#qrysym_code").val(),"FieldID":104},"RequestID":++requestID};
	send(dic);
}

/*
创建Sockjs连接
*/
function onCreateSocket()
{
	if(conn != null)
	{
		conn.close();
	}
	address = $("#sockjs_address").val();
	debug('connect to server:'+address);
	conn = new WebSocket(address);
	//消息回调
	conn.onmessage = onSockMessage;
	//conn.onheartbeat = onHeartbeat;
	conn.onopen = function() {
		debug('websocket connected');
	};

	
	conn.onclose = function() {
		debug('socket close')
  };
}

$(document).ready(
	function()
	{
		debug('Welcome web Market api');
  });
            
</script>
										
</body>
</html>
